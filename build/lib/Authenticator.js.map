{"version":3,"sources":["../../src/lib/Authenticator.js"],"names":[],"mappings":"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","file":"lib/Authenticator.js","sourcesContent":["import { debuglog } from 'util'\nimport { Session } from 'rqt'\nimport { ok } from 'assert'\nimport { askSingle } from 'reloquent'\nimport {\n  extractOptions, extractFormState, askForNumber,\n} from '.'\n\nconst LOG = debuglog('@rqt/namecheap-web')\n\n/**\n * A class used for 2-factor authentication.\n */\nexport default class Authenticator {\n  constructor({\n    username,\n    password,\n    phone,\n    host,\n    userAgent,\n  } = {}) {\n    const session = new Session({\n      host,\n      headers: {\n        'User-Agent': userAgent,\n      },\n    })\n    this._username = username\n    this._password = password\n    this._session = session\n    this._phone = phone\n  }\n  async obtainSession() {\n    const u = '/cart/ajax/SessionHandler.ashx'\n    const { SessionKey } = await this.session.jqt(u)\n    if (!SessionKey) {\n      throw new Error(`Could not acquire the session key from ${u}.`)\n    }\n    LOG('Obtained a session key %s', SessionKey)\n    this.SessionKey = SessionKey\n  }\n  async signIn() {\n    const {\n      body,\n      statusCode,\n      headers: { location },\n    } = await this.session.aqt(Authenticator.LOGIN_URL, {\n      data: {\n        hidden_LoginPassword: '',\n        LoginUserName: this._username,\n        LoginPassword: this._password,\n        sessionEncryptValue: this.SessionKey,\n      },\n      type: 'form',\n    })\n    if (statusCode == 200) {\n      this.checkValidationError(body) // throws with validation message\n    } else if (statusCode == 301) {\n      return this.session.cookies\n    }\n    if (statusCode == 302 && location.includes(Authenticator.SECOND_AUTH_URL)) {\n      await this.secondAuth()\n    } else {\n      throw new Error(`Unknown result (status code ${statusCode})`)\n    }\n    const { cookies } = this.session\n    return cookies\n  }\n  static get LOGIN_URL() {\n    return '/myaccount/login-signup.aspx'\n  }\n  static get SECOND_AUTH_URL() {\n    return '/myaccount/twofa/secondauth.aspx'\n  }\n  async secondAuth() {\n    const body = await this.session.rqt(Authenticator.SECOND_AUTH_URL)\n\n    ok(\n      /Select Phone Contact Number/.test(body),\n      'Could not find the \"Select Phone\" section.',\n    )\n\n    const options = extractOptions(body)\n    ok(options.length, 'Could not find any numbers.')\n\n    const value = await askForNumber(options, this._phone)\n\n    const fs = extractFormState(body)\n    const data = {\n      ...fs,\n      ctl00$ctl00$ctl00$ctl00$base_content$web_base_content$home_content$page_content_left$CntrlAuthorization$ddlAuthorizeList: value,\n      ctl00$ctl00$ctl00$ctl00$base_content$web_base_content$home_content$page_content_left$CntrlAuthorization$btnSendVerification: 'Proceed with Login',\n    }\n    const body2 = await this.session.rqt(Authenticator.SECOND_AUTH_URL, {\n      data,\n      type: 'form',\n    })\n\n    if (/You have reached the limit on the number.+/m.test(body2)) {\n      throw new Error(body2.match(/You have reached the limit on the number.+/m)[0])\n    }\n    ok(\n      /We sent a message with the verification code/.test(body2),\n      'Could not find the code entry section.',\n    )\n\n    await this.submitCode(body2)\n  }\n  async submitCode(body) {\n    const [, b] = /Your 6-digit code begins with (\\d)./.exec(body) || []\n    if (!b) throw new Error('Could not send the code.')\n\n    const code = await askSingle({\n      text: `Security code (begins with ${b})`,\n    })\n    const fs = extractFormState(body)\n    const data = {\n      ...fs,\n      ctl00$ctl00$ctl00$ctl00$base_content$web_base_content$home_content$page_content_left$CntrlAuthorization$txtAuthVerification: code,\n      ctl00$ctl00$ctl00$ctl00$base_content$web_base_content$home_content$page_content_left$CntrlAuthorization$btnVerify: 'Submit Security Code',\n    }\n\n    const {\n      body: body2,\n      headers: { location: location2 },\n    } = await this.session.aqt(Authenticator.SECOND_AUTH_URL, {\n      data,\n      type: 'form',\n    })\n    if (/Oops, you entered an invalid code.+/m.test(body2)) {\n      console.log('Incorrect code, try again.')\n      const res = await this.submitCode(body2)\n      return res\n    }\n    ok(/Object moved/.test(body2), 'Expected to have been redirected after sign-in.')\n    return location2\n  }\n  checkValidationError(body = this.body) {\n    const validationErrorRe = /<strong class=\"title\">Validation Error<\\/strong>\\s+<div>(.+?)<\\/div>/\n    const [, err] = validationErrorRe.exec(body) || []\n    if (err) throw new Error(err.replace(/(<([^>]+)>)/ig, ''))\n  }\n  get session() {\n    return this._session\n  }\n}"]}